[% USE raw %]
[% USE Asset %]
[% USE Koha %]
[% USE KohaDates %]
[% USE Branches %]
[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>
 [% IF step == 2 %] Confirm &rsaquo; [% END %] [% IF step == 3 %] Finished &rsaquo; [% END %] Batch user deletion and anonymisation &rsaquo; Tools &rsaquo; Koha </title>
[% INCLUDE 'doc-head-close.inc' %]
</head>

<body id="tools_cleanborrowers" class="tools">
[% INCLUDE 'header.inc' %]
[% INCLUDE 'cat-search.inc' %]

<nav id="breadcrumbs" aria-label="Breadcrumb" class="breadcrumb">
 <ol>
 <li>
 <a href="/cgi-bin/koha/mainpage.pl">Home</a>
 </li>
 <li>
 <a href="/cgi-bin/koha/tools/tools-home.pl">Tools</a>
 </li>

 [% IF step == 1 %]
 <li>
 <a href="#" aria-current="page">
 Batch user deletion and anonymisation </a>
 </li>
 [% ELSE %]
 <li>
 <a href="/cgi-bin/koha/tools/cleanborrowers.pl">Batch user deletion and anonymisation</a>
 </li>
 [% END %]

 [% IF step == 2 %]
 <li>
 <a href="#" aria-current="page">
 Confirm
 </a>
 </li>
 [% END %]

 [% IF step == 3 %]
 <li>
 <a href="#" aria-current="page">
 Finished
 </a>
 </li>
 [% END %]
 </ol>
</nav>

<div class="main container-fluid">
 <div class="row">
 <div class="col-sm-10 col-sm-push-2">
 <main>

[% IF !OnlyMine %]
 [% IF current_branch == '*' %]
 <h1>Batch user deletion and anonymisation</h1>
 [% ELSE %]
 <h1>Batch user deletion and anonymisation for [% Branches.GetName( current_branch ) | html %]</h1>
 [% END %]
 [% IF step == 1 %]
 <form method="get" action="/cgi-bin/koha/tools/cleanborrowers.pl" id="selectlibrary">
 Select a library :
 <select name="branch" id="branch" style="width:20em;">
 <option value="*">All libraries</option>
 [% FOREACH branch IN Branches.all( selected => current_branch ) %]
 [% IF branch.selected %]
 <option value="[% branch.branchcode | html %]" selected="selected">[% branch.branchname | html %]</option>
 [% ELSE %]
 <option value="[% branch.branchcode | html %]">[% branch.branchname | html %]</option>
 [% END %]
 [% END %]
 </select>
 </form>
 [% END %]
[% ELSE %]
 <h1>Batch user deletion and anonymisation for [% Branches.GetLoggedInBranchname | html %]</h1>
[% END %]

[% IF step == 1 %]
<!-- step 1 START -->

<div class="help">
 <p>This tool allows you to delete users and anonymise borrowing history. For deleting users, any combination of limits can be used. Users will not be deleted if they meet one or more of the following conditions:</p>
<ul>
<li>They have items currently issued.</li>
<li>They have a non-zero account balance.</li>
<li>They are the guarantor to another user.</li>
<li>They are in a user category of type staff.</li>
<li>They have permissions assigned to them.</li>
</ul>
</div>
<div id="step1">
 <form name="f1" id="delete_patrons_form" action="/cgi-bin/koha/tools/cleanborrowers.pl" method="post">
 <fieldset>
 <legend>Delete users</legend>
 <h3><input id="checkborrower" type="checkbox" name="checkbox" value="borrower" /><label for="checkborrower"> Verify you want to delete users</label></h3>
 <br />
 <h5>Delete users who meet the following criteria:</h5>
 <ul>
 <li>
 <label for="date1">who have not borrowed since:</label>
 <input size="10" id="date1" name="not_borrowed_since" type="text" class="flatpickr" />
 <span class="hint">[% INCLUDE 'date-format.inc' %]</span>
 </li>
 <li>
 <label for="borrower_dateexpiry">whose expiration date is before:</label>
 <input size="10" id="borrower_dateexpiry" name="borrower_dateexpiry" type="text" class="flatpickr" />
 <span class="hint">[% INCLUDE 'date-format.inc' %]</span>
 </li>
 [% IF Koha.Preference('TrackLastPatronActivity') %]
 <li>
 <label for="borrower_lastseen">who have not been connected since:</label>
 <input size="10" id="borrower_lastseen" name="borrower_lastseen" type="text" class="flatpickr" />
 <span class="hint">[% INCLUDE 'date-format.inc' %]</span>
 </li>
 [% END %]
 <li>
 <label for="borrower_categorycode">whose user category is:</label>
 <select id="borrower_categorycode" name="borrower_categorycode">
 <option value="" selected="selected">Any</option>
 [% FOREACH bc IN borrower_categorycodes %]
 [% UNLESS bc.category_type == 'S' %]
 <option value="[% bc.categorycode | html %]">[% bc.description | html %]</option>
 [% END %]
 [% END %]
 </select>
 </li>
 [% IF patron_lists %]
 <li>
 <label for="patron_list_id">who are in user list: </label>
 <select id="patron_list_id" name="patron_list_id">
 <option value=""></option>
 [% FOREACH pl IN patron_lists %]
 <option value="[% pl.patron_list_id | html %]">[% pl.name | html %]</option>
 [% END %]
 </select>
 </li>
 [% END %]
 </ul>
 </fieldset>

 <fieldset>
 <legend>Anonymise borrowing history</legend>
 [% UNLESS Koha.Preference('AnonymousPatron') %]
 <div class="dialog message">The AnonymousPatron system preference is not defined. You can use this feature anyway but NULL will be used to update the borrowing history.</div>
 [% END %]
 <h3><input id="checkissue" type="checkbox" name="checkbox" value="issue" /><label for="checkissue"> Verify you want to anonymise user borrowing history</label></h3>
 <br />
 <ul>
 <li>
 <label for="date2">Permanently delete borrowing history older than</label>
 <input size="10" id="date2" name="last_issue_date" type="text" class="flatpickr" />
 <span class="hint">[% INCLUDE 'date-format.inc' %]</span>
 </li>
 </ul>

 <!-- hidden here -->
 <input type="hidden" name="step" value="2" />
 <input type="hidden" name="branch" value="[% current_branch | html %]" />
 </fieldset>
 <fieldset class="action"><input type="submit" value="Next &gt;&gt;" /></fieldset>
 </form>
</div>
<!-- step 1 END -->
[% END %]

[% IF step == 2 %]
<!-- STEP 2 START -->
<div id="step2">
 <form name="f2" action="/cgi-bin/koha/tools/cleanborrowers.pl" method="post">

 <div class="dialog alert">
 <h3>Warning</h3>
 <ul>
 <li>[% patrons_to_delete.size || 0 | html %] users will be deleted</li>
 <li>[% patrons_to_anonymize.count || 0 | html %] users borrowing history will be anonymised</li>
 </ul>
 </div>

 [% IF patrons_to_delete.size %]
 <fieldset>
 <legend>How should users be deleted?</legend>
 <p>
 <input id="delete" type="radio" name="radio" value="delete" />
 <label for="delete">Permanently delete these users</label>
 <div class="hint">
 Delete users directly from the database. User data will not be recoverable. </div>
 </p>
 <p>
 <input id="trash" type="radio" name="radio" value="trash" />
 <label for="trash">Move these users to the trash</label>
 <div class="hint">
 Move users to the deleted users table. They can be deleted permanently by the <code>cleanup_database</code> script.
 </div>
 </p>
 <p>
 <input id="testrun" type="radio" name="radio" value="testrun" checked="checked" />
 <label for="testrun">Test run: Do not remove any users.</label>
 <input type="hidden" name="do_delete" value="[% patrons_to_delete.size | html %]" /></fieldset>
 </p>
 </fieldset>
 [% END %]

 [% IF patrons_to_anonymize.count %]
 <fieldset>
 Borrowing history for [% patrons_to_anonymize.count | html %] users will be anonymised <input type="hidden" name="do_anonym" value="[% patrons_to_anonymize.count | html %]" />
 </fieldset>
 [% END %]

 <input type="hidden" name="step" value="3" />
 <input type="hidden" name="not_borrowed_since" value="[% not_borrowed_since | $KohaDates %]" />
 <input type="hidden" name="last_issue_date" value="[% last_issue_date | $KohaDates %]" />
 <input type="hidden" name="borrower_dateexpiry" value="[% borrower_dateexpiry | $KohaDates %]" />
 [% IF Koha.Preference('TrackLastPatronActivity') %]
 <input type="hidden" name="borrower_lastseen" value="[% borrower_lastseen | $KohaDates %]" />
 [% END %]
 <input type="hidden" name="borrower_categorycode" value="[% borrower_categorycode | html %]" />
 <input type="hidden" name="patron_list_id" value="[% patron_list_id | html %]" />
 <input type="hidden" name="branch" value="[% current_branch | html %]" />
 <fieldset class="action"><input type="submit" value="Finish" /> <a class="cancel" href="/cgi-bin/koha/tools/cleanborrowers.pl">Cancel</a></fieldset>
 </form>
</div>
<!-- STEP 2 END -->
[% END %]

[% IF step == 3 %]
<!-- Step 3 START -->

 <div id="step3">
 [% IF ( testrun ) %]
 <h4>[% TotalDel | html %] users would have been removed (if it wasn't a test run)</h4>
 <h4>No user records have been actually removed</h4>
 [% ELSE %]
 [% IF ( do_delete ) %]
 [% IF ( trash ) %]
 <h4>[% TotalDel | html %] users have been successfully moved to trash</h4>
 [% ELSE %]
 <h4>[% TotalDel | html %] users have been successfully deleted</h4>
 [% END %]
 [% ELSE %]
 <h4>No user records have been removed</h4>
 [% END %]
 [% END %]
 [% IF do_anonym %]
 <h4>All loans ([% do_anonym | html %]) older than [% last_issue_date | $KohaDates %] have been anonymised</h4>
 [% ELSE %]
 <h4>No user records have been anonymised</h4>
 [% END %]

 </div>
<!-- Step 3 END -->
[% END %]

 </main>
 </div> <!-- /.col-sm-10.col-sm-push-2 -->

 <div class="col-sm-2 col-sm-pull-10">
 <aside>
 [% INCLUDE 'tools-menu.inc' %]
 </aside>
 </div> <!-- /.col-sm-2.col-sm-pull-10 -->
 </div> <!-- /.row -->

[% MACRO jsinclude BLOCK %]
 [% Asset.js("js/tools-menu.js") | $raw %]
 [% INCLUDE 'calendar.inc' %]
 <script>
        $(document).ready(function(){
            $("#delete_patrons_form").on("submit",function(){
                return checkForm( this );
            });

            $('#branch').change(function() {
                $('#selectlibrary').submit();
            });
            $("form[name='f2']").on('submit',function(){
                if( $("#delete").prop("checked") ){
                    if( !confirm(_("These users will be permanently removed from the database and cannot be recovered")) ){
                        return false;
                    }
                }
            });
        });

        /**
         *  checkForm(form)
         *  This function check the form is correctly filled.
         */
        function checkForm(form) {
            if((form.checkbox[0].checked)){
                if ( (!form.date1.value) && (!form.borrower_dateexpiry.value) [% IF Koha.Preference('TrackLastPatronActivity') %]&& (!form.borrower_lastseen.value) [% END %]&& (!form.borrower_categorycode.value) && (!form.patron_list_id.value)){
                  alert(_("Please enter at least one criterion for deletion!"));
                  return false;
                }
            }
            if((form.checkbox[1].checked)){
                if(!(form.date2.value)){
                    alert(_("Please enter a date!"));
                    return false;
                }
            }
            if(!form.checkbox[0].checked && !form.checkbox[1].checked) {
              alert( _("Please check at least one action") );
              return false;
            }
            return true;
        }
    </script>
[% END %]

[% INCLUDE 'intranet-bottom.inc' %]
