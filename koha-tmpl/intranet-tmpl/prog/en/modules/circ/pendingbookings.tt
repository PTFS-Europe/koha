[% USE raw %]
[% USE Asset %]
[% USE TablesSettings %]
[% USE KohaDates %]
[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>Bookings to collect &rsaquo; Circulation &rsaquo; Koha</title>
[% INCLUDE 'doc-head-close.inc' %]
</head>

<body id="circ_pendingbookings" class="circ">
    [% INCLUDE 'header.inc' %]
    [% INCLUDE 'circ-search.inc' %]

    <nav id="breadcrumbs" aria-label="Breadcrumb" class="breadcrumb">
        <ol>
            <li>
                <a href="/cgi-bin/koha/mainpage.pl">Home</a>
            </li>
            <li>
                <a href="/cgi-bin/koha/circ/circulation-home.pl">Circulation</a>
            </li>
            <li>
                <a href="#" aria-current="page">
                Bookings to collect
            </a>
            </li>
        </ol>
    </nav>

    <div class="main container-fluid">
        <div class="row">

            <!-- Results -->
            <div class="col-sm-10 col-sm-push-2">
                <main>
                    <h2>Items required for bookings between <span id="from_date">[% from | $KohaDates %]</span> and <span id="to_date">[% to | $KohaDates %]</span></h2>
                    <h3>Reported on [% todaysdate | $KohaDates %]</h3>
                    <p>The following items have not been collected for bookings. Please retrieve them
                        and check them in.</p>
                    <div id="searchresults">
                        <table id="bookingst"></table>
                    </div>
                </main>
            </div>

            <!-- Filters -->
            <div class="col-sm-2 col-sm-pull-10">
                <aside>
                    <div id="filters">
                        <form id="bookingsf">
                            <fieldset class="brief">
                                <h4>Refine results</h4>
                                <ol>
                                    <li>
                                        <label for="from">Start date: </label>
                                        <input type="text" size="10" id="from" name="from" value="[% from | $KohaDates %]" class="flatpickr" data-date_to="to"/>
                                    </li>
                                    <li>
                                        <label for="to">End date: </label>
                                        <input type="text" size="10" id="to" name="to" value="[% to | $KohaDates %]" class="flatpickr"/>
                                    </li>
                                </ol>

                                <fieldset class="action">
                                    <input type="submit" name="run_report" value="Submit" class="submit"/>
                                </fieldset>
                            </fieldset>
                        </form>
                    </div>
                </aside>
            </div>
        </div>
        <!-- /.row -->

        [% MACRO jsinclude BLOCK %]
        [% INCLUDE 'calendar.inc' %]
        [% INCLUDE 'datatables.inc' %]
        [% INCLUDE 'columns_settings.inc' %]
        [% Asset.js("lib/jquery/plugins/jquery.dataTables.columnFilter.js") | $raw %]
        [% INCLUDE 'js-date-format.inc' %]
        <script>
            var columns_settings = [% TablesSettings.GetColumns( 'circ', 'bookings', 'bookings-to-collect', 'json') | $raw %];

            var startdate = "[% from | $KohaDates dateformat => iso %]";
            var enddate = "[% to | $KohaDates dateformat => iso %]";
            $(document).ready(function() {
                var bookings_table_url = '/api/v1/bookings?';
                var bookings_table = $("#bookingst").kohaTable({
                    "ajax": {
                        "url": bookings_table_url
                    },
                    "searchCols": [
                        null,
                        null,
                        null,
                        null,
                        null,
                        { "search": startdate+':'+enddate },
                        null
                    ],
                    "embed": [
                        "biblio",
                        "item",
                        "patron"
                    ],
                    "order": [[ 1, "asc" ]],
                    "columns": [{
                        "data": "booking_id",
                        "title": "Booking ID",
                        "visible": false,
                        "searchable": false,
                        "orderable": false
                    },
                    {
                        "data": "biblio.title",
                        "title": "Title",
                        "searchable": true,
                        "orderable": true,
                        "render": function(data,type,row,meta) {
                            return row.biblio.title;
                        }
                    },
                    {
                        "data": "item.external_id",
                        "title": "Item",
                        "searchable": true,
                        "orderable": true,
                        "defaultContent": "Any item",
                        "render": function(data,type,row,meta) {
                            if ( row.item ) {
                                return row.item.external_id;
                            } else {
                                return null;
                            }
                        }
                    },
                    {
                        "data": "item.callnumber",
                        "title": "Callnumber",
                        "searchable": true,
                        "orderable": true,
                        "defaultContent": "Any item",
                        "render": function(data,type,row,meta) {
                            if ( row.item ) {
                                return row.item.callnumber;
                            } else {
                                return null;
                            }
                        }
                    },
                    {
                        "data": "patron.firstname:patron.surname",
                        "title": "Patron",
                        "searchable": true,
                        "orderable": true,
                        "render": function(data, type, row, meta) {
                            var fullname;
                            if ( row.patron.firstname == null ) {
                                fullname = row.patron.surname;
                            }
                            else {
                                fullname = row.patron.firstname + " " + row.patron.surname;
                            }
                            return escape_str(fullname);
                        }
                    },
                    {
                        "data": "start_date",
                        "name": "start_date",
                        "title": "Booking dates",
                        "type": "date",
                        "searchable": true,
                        "criteria": "between",
                        "orderable": true,
                        "render": function(data, type, row, meta) {
                            return $date(row.start_date) + ' - ' + $date(row.end_date);
                        }
                    },
                    {
                        "name": "actions",
                        "title": "Actions",
                        "searchable": false,
                        "orderable": false,
                        "render": function(data,type,row,meta){
                            return "<button class='btn btn-default btn-xs'>Action 1</button>";
                        }
                    }]
                }, columns_settings, 1);

                /** Date filtering */
                $("#bookingsf").on("submit", function(e){
                    var fromdate = $("#from");
                    var todate = $("#to");

                    var isoFrom;
                    if (fromdate.val() !== '') {
                      isoFrom = fromdate.get(0)._flatpickr.selectedDates[0].toISOString().substring(0,10);
                    }
                    var isoTo;
                    if (todate.val() !== '') {
                        isoTo = todate.get(0)._flatpickr.selectedDates[0].toISOString().substring(0,10);
                    }

                    bookings_table.api().column('start_date:name').search(isoFrom+':'+isoTo).draw();
                    $("#from_date").text(fromdate.val());
                    $("#to_date").text(todate.val());
                    return false;
                });
            });
        </script>
        [% END %]
        [% INCLUDE 'intranet-bottom.inc' %]
