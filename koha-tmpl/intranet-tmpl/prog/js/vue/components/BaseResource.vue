<script>
import { inject } from "vue"
import { build_url } from "../composables/datatables"

export default {
    setup(props) {
        //global setup for all resource (list and show for now, but maybe others?) components here
        const { setConfirmationDialog, setMessage, setError, setWarning } =
            inject("mainStore")

        const AVStore = inject("AVStore")
        const { get_lib_from_av, map_av_dt_filter } = AVStore

        const format_date = $date
        const patron_to_html = $patron_to_html

        return {
            ...props,
            setConfirmationDialog,
            setMessage,
            setError,
            setWarning,
            format_date,
            patron_to_html,
            logged_in_user,
            escape_str,
            get_lib_from_av,
            map_av_dt_filter,
            build_url,
        }
    },
    methods: {
        /**
         * Navigates to the show page of the given resource.
         *
         * @param {Object} resource - The resource to navigate to
         * @return {void}
         */
        goToResourceShow: function (resource) {
            this.$router.push({
                name: this.show_component,
                params: { [this.id_attr]: resource[this.id_attr] },
            })
        },

        /**
         * Navigates to the edit page of the given resource.
         *
         * @param {Object} resource - The resource to navigate to (optional)
         * @return {void}
         */
        goToResourceEdit: function (resource) {
            this.$router.push({
                name: this.edit_component,
                params: {
                    [this.id_attr]: resource
                        ? resource[this.id_attr]
                        : this[this.resource_name][this.id_attr],
                },
            })
        },
        /**
         * Navigates to the creation page of the given resource.
         *
         * @return {void}
         */
        goToResourceAdd: function () {
            this.$router.push({
                name: this.add_component,
            })
        },
        /**
         * Navigates to the list page of the given resource.
         *
         * @return {void}
         */
        goToResourceList: function () {
            this.$router.push({
                name: this.list_component,
            })
        },
        /**
         * Resource deletion handler.
         * Accepts an optional callback function to run after deletion.
         * If no callback is provided, does the following:
         * - If deleting from show component, navigates to resource list component.
         * - If deleting from resource list component, redraws the table.
         *
         * @param {Object} resource - The resource to delete (optional)
         * @param {Object} callback - Callback to call after deletion (optional)
         * @return {void}
         */
        doResourceDelete: function (resource, callback) {
            let resource_id = resource
                ? resource[this.id_attr]
                : this[this.resource_name][this.id_attr]
            let resource_name = resource
                ? resource[this.name_attr]
                : this[this.resource_name][this.name_attr]

            this.setConfirmationDialog(
                {
                    title: this.$__(
                        "Are you sure you want to remove this %s?"
                    ).format(this.i18n.display_name.toLowerCase()),
                    message: resource_name,
                    accept_label: this.$__("Yes, delete"),
                    cancel_label: this.$__("No, do not delete"),
                },
                () => {
                    this.api_client.delete(resource_id).then(
                        success => {
                            this.setMessage(
                                this.$__("%s %s deleted").format(
                                    this.i18n.display_name,
                                    resource_name
                                ),
                                true
                            )
                            if (typeof callback === "function") {
                                callback()
                            } else {
                                if (
                                    this.$options.name === this.list_component
                                ) {
                                    this.$refs.table.redraw(
                                        this.getResourceTableUrl()
                                    )
                                } else if (
                                    this.$options.name === this.show_component
                                ) {
                                    this.goToResourceList()
                                }
                            }
                        },
                        error => {}
                    )
                }
            )
        },
        /**
         * Return the URL for the resource table.
         *
         * @return {string}
         */
        getResourceTableUrl: function () {
            return this.resource_table_url
        },
        getResourceTableColumns: function () {
            //This is where I left off
            let table_attrs = this.resource_attrs.filter(
                attr => attr.show_in_table
            )
        },
        doResourceSelect: function (resource, dt, event) {
            this.$emit("select-resource", resource[this.id_attr])
        },
        assignAVs(attrs) {
            attrs.forEach(attr => {
                if (attr.type === "select" && typeof attr.av_cat === "string") {
                    const av_key = attr.av_cat
                    attr.options = this[av_key]
                    attr.requiredKey = "value"
                    attr.selectLabel = "description"
                }
                if (attr.type == "relationship" && attr.props) {
                    Object.keys(attr.props).forEach(key => {
                        if (attr.props[key].type == "av") {
                            attr.props[key].av = this[key]
                        }
                    })
                }
                if (attr.subFields?.length) {
                    this.assignAVs(attr.subFields)
                }
            })
        },
        additionalFieldsChanged(additionalFieldValues, resource) {
            resource.extended_attributes = additionalFieldValues
        },
        getFilters(query, filterData) {
            const filters = filterData ? filterData : this.tableFilters
            const filterOptions = filters.reduce((acc, filter) => {
                acc[filter.name] = filter.value
                return acc
            }, {})

            Object.keys(query).forEach(key => {
                if (
                    filterOptions.hasOwnProperty(key) &&
                    query[key] !== filterOptions[key]
                ) {
                    filterOptions[key] = query[key]
                }
                if (!filterOptions.hasOwnProperty(key)) {
                    filterOptions[key] = query[key]
                }
            })
            return filterOptions
        },
    },
    name: "BaseResource",
    props: {
        resource_name: String,
        id_attr: String,
        show_component: String,
        add_component: String,
        edit_component: String,
    },
}
</script>
