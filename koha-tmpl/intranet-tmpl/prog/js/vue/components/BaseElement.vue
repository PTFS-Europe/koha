<script>
import { defineAsyncComponent } from "vue"
import { inject } from "vue"

export default {
    setup(props) {
        //global setup for anything required to render form/show elements
        const AVStore = inject("AVStore")
        const { get_lib_from_av } = AVStore

        return {
            ...props,
            get_lib_from_av,
        }
    },
    methods: {
        identifyAndImportComponent(attr, show = false) {
            const importPath = show
                ? attr.showElement.componentPath
                : attr.componentPath

            return defineAsyncComponent(() => import(`${importPath}`))
        },
        requiredProps(show = false) {
            const propList = show
                ? this.attr.showElement.props
                : this.attr.props
            if (!propList) {
                return {}
            }
            const props = Object.keys(propList).reduce((acc, key) => {
                // This might be better in a switch statement
                const prop = propList[key]
                if (prop.type === "resource") {
                    acc[key] = this.resource
                }
                if (prop.type === "resourceProperty") {
                    if (prop.resourceProperty.includes(".")) {
                        acc[key] = this.accessNestedProperty(
                            prop.resourceProperty,
                            this.resource
                        )
                    } else {
                        acc[key] = this.resource[prop.resourceProperty]
                    }
                }
                if (prop.type === "av") {
                    acc[key] = prop.av
                }
                if (prop.type === "string") {
                    if (prop.indexRequired && this.index > -1) {
                        acc[key] = `${prop.value}${this.index}`
                    } else {
                        acc[key] = prop.value
                    }
                }
                if (prop.type === "boolean" || prop.type === "object") {
                    acc[key] = prop.value
                }

                if (key === "disabled") {
                    const currentValue = acc[key]
                    acc[key] = !!currentValue
                }
                return acc
            }, {})
            const attr = show ? this.attr.showElement : this.attr
            if (attr.subFields?.length) {
                props.subFields = attr.subFields
            }
            console.log("props")
            console.log(props)
            return props
        },
        accessNestedProperty(path, obj) {
            const keys = path.split(".")
            let property = null
            let current = obj
            keys.forEach(key => {
                if (current.hasOwnProperty(key) && current[key]) {
                    property = current[key]
                    current = current[key]
                } else {
                    property = null
                    current = {}
                }
            })
            return property
        },
    },
    name: "BaseElement",
}
</script>
